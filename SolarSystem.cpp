#include <SFML/Graphics.hpp>
#include <cmath>
#include <vector>
#include <string>

// ??????? ????????? ????? ????????? ???????: ??????, ??????, ?????, ???? ? ????.
// - ?????????????? ?????? (??????????)
// - ??????? ???????? ?? ???????? ???????
// - ???? ????????? ?????? ?????
// - ??????????: ?????? - ?????/????, +/- - ?????????/?????????? ???????, R - ????? ????????, Up/Down - ???
// ?????????? (Linux):
//   g++ solar_system_sfml.cpp -o solar -lsfml-graphics -lsfml-window -lsfml-system -std=c++17

static constexpr float PI = 3.14159265358979323846f;

struct Body {
    std::string name;
    float radius;                // ?????????? ?????? (???????)
    sf::Color color;
    float orbitRadius;           // ?????????? ?? ???????? (???????)
    float orbitalPeriodDays;     // ?????? ? ?????? ???? (??? ?????????? ????????)
    float angle;                 // ??????? ???? (???????)
    Body* parent;                // nullptr ??? ??????

    sf::CircleShape shape;       // ??????????? ?????????????
    std::vector<sf::Vertex> trail; // ???? (???????????? ??????)

    Body(const std::string& n, float r, sf::Color c, float orbitR, float periodDays, Body* p = nullptr)
        : name(n), radius(r), color(c), orbitRadius(orbitR), orbitalPeriodDays(periodDays), angle(0.f), parent(p)
    {
        shape.setRadius(radius);
        shape.setOrigin(radius, radius);
        shape.setFillColor(color);
    }

    // ?????????? ??????? ?????? ???? ? ??????? ???????????
    sf::Vector2f worldPosition(const sf::Vector2f& systemCenter) const {
        sf::Vector2f center = systemCenter;
        if (parent) {
            // ???????? ??? ?????? ???? ????????
            // ???????????, ??? parent->shape.getPosition() ???????? ??? ?????????
            center = parent->shape.getPosition();
        }
        float x = center.x + orbitRadius * std::cos(angle);
        float y = center.y + orbitRadius * std::sin(angle);
        return { x, y };
    }

    void addTrailPoint(const sf::Vector2f& pos, std::size_t maxPoints = 400) {
        trail.emplace_back(pos, color);
        if (trail.size() > maxPoints) trail.erase(trail.begin());
    }
};

int main() {
    sf::RenderWindow window(sf::VideoMode(1000, 800), "????????? ??????? (SFML)");
    window.setFramerateLimit(60);

    // ????? ??????? (??????)
    sf::Vector2f center(window.getSize().x / 2.f, window.getSize().y / 2.f);

    // ??????? ????: ??????, ??????, ?????, ????, ????
    Body sun("Sun", 30.f, sf::Color(255, 200, 0), 0.f, 0.f, nullptr);
    // orbitRadius ??? ?????? = 0, period = 0

    Body venus("Venus", 8.f, sf::Color(200, 150, 120), 110.f, 224.7f, &sun);
    Body earth("Earth", 10.f, sf::Color(100, 150, 255), 170.f, 365.25f, &sun);
    Body moon("Moon", 4.f, sf::Color(200, 200, 200), 28.f, 27.3f, &earth);
    Body mars("Mars", 7.f, sf::Color(220, 120, 80), 260.f, 687.f, &sun);

    std::vector<Body*> bodies = { &sun, &venus, &earth, &moon, &mars };

    // ?????????????? ???????? ?????? ? ?????
    sun.shape.setPosition(center);

    // ?????????? ?????????? ????? (outline)
    auto makeOrbitShape = [&](float r)->sf::CircleShape {
        sf::CircleShape s(r);
        s.setOrigin(r, r);
        s.setFillColor(sf::Color::Transparent);
        s.setOutlineColor(sf::Color(120, 120, 120, 120));
        s.setOutlineThickness(1.f);
        s.setPosition(center);
        return s;
        };

    sf::CircleShape orbitVenus = makeOrbitShape(venus.orbitRadius);
    sf::CircleShape orbitEarth = makeOrbitShape(earth.orbitRadius);
    sf::CircleShape orbitMars = makeOrbitShape(mars.orbitRadius);
    // ?????? ?????? ?????????? ?????? ????? ? ??????????? ?????? ????

    // ????????? ?????????
    double timeScale = 600000.0; // ??????? ?????? ????????? = 1 ??? ????????? ??????? (???????????)
    bool paused = false;

    sf::Clock clock;

    // ???????: ????????? ????????? ????? (???? ? ????? ???? font.ttf)
    sf::Font font;
    bool haveFont = font.loadFromFile("font.ttf"); // ???????????? ????? ???????? ????? ttf ? ?????? font.ttf

    sf::Text hud;
    if (haveFont) {
        hud.setFont(font);
        hud.setCharacterSize(14);
        hud.setFillColor(sf::Color::White);
        hud.setPosition(10.f, 10.f);
    }

    float zoom = 1.f;

    while (window.isOpen()) {
        sf::Event event;
        while (window.pollEvent(event)) {
            if (event.type == sf::Event::Closed) window.close();
            if (event.type == sf::Event::KeyPressed) {
                if (event.key.code == sf::Keyboard::Space) paused = !paused;
                if (event.key.code == sf::Keyboard::Add || event.key.code == sf::Keyboard::Equal) timeScale *= 1.5; // +
                if (event.key.code == sf::Keyboard::Hyphen || event.key.code == sf::Keyboard::Subtract) timeScale /= 1.5; // -
                if (event.key.code == sf::Keyboard::R) { timeScale = 600000.0; }
                if (event.key.code == sf::Keyboard::Up) { zoom *= 1.1f; }
                if (event.key.code == sf::Keyboard::Down) { zoom /= 1.1f; }
            }
            if (event.type == sf::Event::MouseWheelScrolled) {
                if (event.mouseWheelScroll.delta > 0) zoom *= 1.06f; else zoom /= 1.06f;
            }
        }

        float dt = clock.restart().asSeconds();
        if (paused) dt = 0.f;

        // ???????? ?? ????? ? ????????? ???? ? ???????
        for (Body* b : bodies) {
            if (b->parent == nullptr) {
                // ?????? ??????????? ? ??????
                b->shape.setPosition(center);
                b->addTrailPoint(b->shape.getPosition());
                continue;
            }

            // ???? ?????? ?????, ?????????? ???????? ??????? (? ????) ??? ?????????? ??????? ????????
            if (b->orbitalPeriodDays > 0.f) {
                double periodSeconds = static_cast<double>(b->orbitalPeriodDays) * 86400.0; // ??? ? ???????
                double angularSpeed = (2.0 * PI) / periodSeconds; // ?????? ? ??????? (????????? ???????)
                // ???????? ?? timeScale — ??????? ???????? ???-?????? ???????? ?? 1 ??? ????????? ???????
                b->angle += static_cast<float>(angularSpeed * (double)dt * timeScale);
            }
            else {
                // ?? ??????, ???? ?????? ?? ????? — ?????? ?? ??????
            }

            sf::Vector2f pos = b->worldPosition(center);
            b->shape.setPosition(pos);
            b->addTrailPoint(pos);

            // ???? ??? ????? — ??????? ?????? ?????? ?????
        }

        // ??????? ? ?????????
        window.clear(sf::Color(5, 5, 20));

        // ????????? ??? ????? view
        sf::View view = window.getDefaultView();
        view.setCenter(center);
        view.setSize(window.getDefaultView().getSize().x / zoom, window.getDefaultView().getSize().y / zoom);
        window.setView(view);

        // ?????? (?????????)
        window.draw(orbitVenus);
        window.draw(orbitEarth);
        window.draw(orbitMars);

        // ?????? ?????? — ???????? ??? ?????????? ?????? ??????? ??????? ?????
        sf::CircleShape orbitMoon(moon.orbitRadius);
        orbitMoon.setOrigin(moon.orbitRadius, moon.orbitRadius);
        orbitMoon.setFillColor(sf::Color::Transparent);
        orbitMoon.setOutlineColor(sf::Color(120, 120, 120, 120));
        orbitMoon.setOutlineThickness(1.f);
        orbitMoon.setPosition(earth.shape.getPosition());
        window.draw(orbitMoon);

        // ?????? (trail) - ?????? ??? ?????
        for (Body* b : bodies) {
            if (b->trail.size() >= 2) {
                sf::VertexArray va(sf::LineStrip, b->trail.size());
                for (std::size_t i = 0; i < b->trail.size(); ++i) va[i] = b->trail[i];
                window.draw(va);
            }
        }

        // ???? ????
        for (Body* b : bodies) window.draw(b->shape);

        // HUD
        if (haveFont) {
            std::string info = "Space - play/pause   +/- - speed   R - reset speed   Up/Down - zoom\n";
            info += "timeScale = " + std::to_string((long long)timeScale) + " sim-sec/sec\n";
            info += "Bodies: Sun, Venus, Earth, Moon, Mars";
            hud.setString(info);
            // HUD ?????? ? ???????? (??????????????) ???????????: ???????? ??????? view
            window.setView(window.getDefaultView());
            window.draw(hud);
            // ??????????? ???-???
            window.setView(view);
        }

        window.display();
    }

    return 0;
}
